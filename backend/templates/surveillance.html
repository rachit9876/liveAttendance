<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Surveillance</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        ::selection { background: #F8BBD9; color: #000; }
        ::-moz-selection { background: #F8BBD9; color: #000; }
        body { font-family: 'Arial Black', sans-serif; background: #00ff00; min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; background: #fff; padding: 30px; border: 5px solid #000; box-shadow: 12px 12px 0 #000; }
        .main-content { display: flex; gap: 20px; }
        .left-panel { flex: 1; }
        .right-panel { width: 400px; border: 4px solid #000; padding: 15px; background: #f9f9f9; max-height: 600px; overflow-y: auto; }
        .right-panel h2 { font-size: 1.2em; margin-bottom: 15px; text-align: center; }
        .log-entry { background: #fff; border: 3px solid #000; padding: 10px; margin-bottom: 10px; box-shadow: 4px 4px 0 #000; }
        .log-entry strong { color: #dc3545; }
        .log-entry small { display: block; margin-top: 5px; color: #666; }
        h1 { color: #000; margin-bottom: 20px; text-align: center; text-transform: uppercase; font-size: 2em; }
        .video-container { position: relative; display: inline-block; margin: 0 auto; }
        video { width: 100%; max-width: 800px; border: 5px solid #000; display: block; margin: 0 auto; box-shadow: 8px 8px 0 #000; transform: scaleX(-1); }
        canvas { position: absolute; top: 0; left: 50%; transform: translateX(-50%) scaleX(-1); pointer-events: none; }
        .controls { text-align: center; margin: 20px 0; }
        .btn { padding: 12px 30px; background: #ffd700; color: #000; border: 4px solid #000; cursor: pointer; font-size: 16px; margin: 5px; font-weight: bold; text-transform: uppercase; box-shadow: 5px 5px 0 #000; transition: all 0.1s; }
        .btn:hover { transform: translate(2px, 2px); box-shadow: 3px 3px 0 #000; }
        .btn.stop { background: #ff00ff; }
        .back-link { display: inline-block; margin-top: 20px; color: #000; text-decoration: none; font-weight: bold; border-bottom: 3px solid #000; }
        .back-link:hover { background: #ffd700; }
        .status { text-align: center; margin: 10px 0; font-size: 18px; color: #000; font-weight: bold; text-transform: uppercase; }
        .sleep-alert { text-align: center; margin: 15px 0; padding: 15px; background: #ff6b6b; border: 4px solid #000; box-shadow: 5px 5px 0 #000; display: none; }
        .sleep-alert h3 { color: #fff; margin-bottom: 10px; }
        .btn-check { background: #ffd700; padding: 12px 30px; border: 4px solid #000; cursor: pointer; font-size: 16px; font-weight: bold; text-transform: uppercase; box-shadow: 5px 5px 0 #000; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; box-shadow: 5px 5px 0 #000; }
            .main-content { flex-direction: column; }
            .right-panel { width: 100%; max-height: 400px; }
            h1 { font-size: 1.3em; }
            video { max-width: 100%; box-shadow: 4px 4px 0 #000; }
            canvas { max-width: 100%; }
            .btn { padding: 10px 20px; font-size: 14px; margin: 5px 0; display: block; width: 100%; }
            .status { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Live Surveillance Mode</h1>
        <p style="text-align: center; color: #666; margin-bottom: 20px;">Real-time face detection with sleeping monitoring</p>
        
        <div class="main-content">
            <div class="left-panel">
                <div style="text-align: center; margin-bottom: 15px;">
                    <label style="font-weight: bold; margin-right: 10px;">Camera:</label>
                    <select id="cameraSelect" style="padding: 8px; border: 3px solid #000; font-size: 14px; background: #fff; font-family: 'Arial Black', sans-serif;">
                        <option value="">Loading cameras...</option>
                    </select>
                </div>
                
                <div class="video-container">
                    <video id="video" autoplay></video>
                    <canvas id="canvas"></canvas>
                </div>
                
                <div class="controls">
                    <button class="btn" id="startBtn">Start Surveillance</button>
                    <button class="btn stop" id="stopBtn" style="display: none;">Stop Surveillance</button>
                </div>
                
                <div class="status" id="status">Click Start to begin surveillance</div>
                
                <div class="sleep-alert" id="sleepAlert">
                    <h3>‚ö†Ô∏è Eyes Closed for 2+ Seconds!</h3>
                    <button class="btn-check" id="checkSleepingBtn">Check for Sleeping Log Now</button>
                </div>
                
                <a href="/" class="back-link">‚Üê Back to Home</a>
            </div>
            
            <div class="right-panel">
                <h2>üí§ Sleeping Log</h2>
                <div id="sleepingLog">No sleeping incidents recorded</div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');
        
        let isRunning = false;
        let detectionInterval;
        let eyeClosedTimes = {};
        let processingFrame = false;
        let currentStream = null;
        const cameraSelect = document.getElementById('cameraSelect');
        const sleepingLog = document.getElementById('sleepingLog');
        const sleepAlert = document.getElementById('sleepAlert');
        const checkSleepingBtn = document.getElementById('checkSleepingBtn');
        let capturedSleepingImage = null;

        async function loadCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                cameraSelect.innerHTML = '';
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                if (videoDevices.length > 0) {
                    startCamera(videoDevices[0].deviceId);
                }
            } catch (err) {
                statusDiv.textContent = 'Cannot access cameras';
                statusDiv.style.color = '#dc3545';
            }
        }

        async function startCamera(deviceId) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { deviceId: deviceId ? { exact: deviceId } : undefined, width: 480, height: 360 } 
                });
                currentStream = stream;
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };
            } catch (err) {
                statusDiv.textContent = 'Camera access denied';
                statusDiv.style.color = '#dc3545';
            }
        }

        cameraSelect.addEventListener('change', () => {
            startCamera(cameraSelect.value);
        });

        loadCameras();

        startBtn.addEventListener('click', () => {
            isRunning = true;
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            statusDiv.textContent = 'Surveillance active...';
            statusDiv.style.color = '#28a745';
            cameraSelect.disabled = true;
            startDetection();
        });

        stopBtn.addEventListener('click', () => {
            isRunning = false;
            stopBtn.style.display = 'none';
            startBtn.style.display = 'inline-block';
            statusDiv.textContent = 'Surveillance stopped';
            statusDiv.style.color = '#666';
            clearInterval(detectionInterval);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            eyeClosedTimes = {};
            sleepAlert.style.display = 'none';
            capturedSleepingImage = null;
            cameraSelect.disabled = false;
        });

        checkSleepingBtn.addEventListener('click', async () => {
            if (!capturedSleepingImage) return;
            
            checkSleepingBtn.disabled = true;
            checkSleepingBtn.textContent = 'Processing...';
            
            try {
                const response = await fetch('/api/match_sleeping_face', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_path: capturedSleepingImage })
                });

                const data = await response.json();
                if (data.success) {
                    statusDiv.textContent = `‚úÖ Logged: ${data.name} (${data.roll_number})`;
                    statusDiv.style.color = '#28a745';
                    loadSleepingLogs();
                } else {
                    statusDiv.textContent = '‚ùå Face not recognized';
                    statusDiv.style.color = '#dc3545';
                }
            } catch (error) {
                statusDiv.textContent = '‚ùå Error processing';
                statusDiv.style.color = '#dc3545';
            }
            
            sleepAlert.style.display = 'none';
            capturedSleepingImage = null;
            checkSleepingBtn.disabled = false;
            checkSleepingBtn.textContent = 'Check for Sleeping Log Now';
        });

        async function loadSleepingLogs() {
            try {
                const response = await fetch('/api/sleeping_logs');
                const logs = await response.json();
                
                if (logs.length === 0) {
                    sleepingLog.innerHTML = '<p style="text-align: center; color: #999;">No sleeping incidents recorded</p>';
                } else {
                    sleepingLog.innerHTML = logs.reverse().map(log => `
                        <div class="log-entry">
                            <strong>${log.Name}</strong> (${log['Roll Number']})<br>
                            <small>üìÖ ${log.Date} ‚è∞ ${log.Time}</small>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        loadSleepingLogs();
        setInterval(loadSleepingLogs, 5000);

        function startDetection() {
            detectionInterval = setInterval(async () => {
                if (!isRunning || processingFrame) return;
                
                processingFrame = true;
                
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                tempCanvas.getContext('2d').drawImage(video, 0, 0);
                const imageData = tempCanvas.toDataURL('image/jpeg', 0.5);

                try {
                    const response = await fetch('/api/detect_faces', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: imageData })
                    });

                    const data = await response.json();
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    if (data.success && data.faces.length > 0) {
                        statusDiv.textContent = `Detected ${data.faces.length} face(s)`;
                        
                        let anyEyesClosed = false;
                        
                        data.faces.forEach((face, index) => {
                            const color = face.eyes < 2 ? '#dc3545' : '#28a745';
                            const faceId = `face_${index}`;
                            
                            if (face.eyes < 2) {
                                anyEyesClosed = true;
                                if (!eyeClosedTimes[faceId]) {
                                    eyeClosedTimes[faceId] = Date.now();
                                } else {
                                    const elapsed = (Date.now() - eyeClosedTimes[faceId]) / 1000;
                                    if (elapsed >= 2 && !capturedSleepingImage) {
                                        const tempCanvas = document.createElement('canvas');
                                        tempCanvas.width = video.videoWidth;
                                        tempCanvas.height = video.videoHeight;
                                        tempCanvas.getContext('2d').drawImage(video, 0, 0);
                                        const imageData = tempCanvas.toDataURL('image/jpeg', 0.8);
                                        
                                        fetch('/api/save_sleeping_image', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ image: imageData })
                                        }).then(res => res.json()).then(data => {
                                            if (data.success) {
                                                capturedSleepingImage = data.image_path;
                                                sleepAlert.style.display = 'block';
                                            }
                                        });
                                    }
                                }
                            } else {
                                delete eyeClosedTimes[faceId];
                            }
                            
                            ctx.strokeStyle = color;
                            ctx.lineWidth = 3;
                            ctx.strokeRect(face.x, face.y, face.w, face.h);
                            
                            ctx.fillStyle = color;
                            ctx.fillRect(face.x, face.y - 35, face.w, 35);
                            
                            ctx.save();
                            ctx.scale(-1, 1);
                            ctx.fillStyle = 'white';
                            ctx.font = 'bold 14px Arial';
                            ctx.fillText('Eyes: ' + (face.eyes === 2 ? 'Open' : 'Closed'), -(face.x + face.w - 5), face.y - 10);
                            ctx.restore();
                        });
                        if (!anyEyesClosed) {
                            eyeClosedTimes = {};
                        }
                    } else {
                        statusDiv.textContent = 'No faces detected';
                        eyeClosedTimes = {};
                    }
                } catch (error) {
                    console.error('Detection error:', error);
                }
                
                processingFrame = false;
            }, 500);
        }
    </script>
</body>
</html>
